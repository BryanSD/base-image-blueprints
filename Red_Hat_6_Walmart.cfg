# Kickstart config file generated by Red Hat Satellite Config Management
# Profile Label : HO-Standard-RHEL-6-Production
# Date Created  : 2013-04-20 12:14:25.0

install
text
cdrom
lang en_US
keyboard us
timezone --utc UTC
auth --enablemd5 --enableshadow
rootpw --iscrypted $5$nhu9lZJdnsks1pva$Nyg1kbUKPFvvGmNmIk9oNH6gEMwZ6K/Wfr0fYv8VrG/
selinux --permissive
poweroff
firewall --disabled
skipx
graphical
repo --name=base --baseurl=http://intra.mirror.rackspace.com/kickstart/rhel-x86_64-server-6/
repo --name=common --baseurl=http://INTERNAL_HOST/centos-repos/rackspace-rhel-x86_64-server-6-common/
repo --name=optional --baseurl=http://INTERNAL_HOST/centos-repos/rhel-x86_64-server-optional-6/
repo --name=suse-tools --baseurl=http://INTERNAL_HOST/centos-repos/centos6-x86_64-suse-tools/
repo --name=epel --baseurl=http://mirror.rackspace.com/epel/6/x86_64/
network --onboot yes --device eth0 --bootproto dhcp --ipv6 auto --hostname localhost
zerombr
clearpart --all --initlabel
part / --fstype=ext4 --grow --size=1024 --asprimary
bootloader --timeout=1 --append="console=ttyS0,115200n8 console=hvc0 console=tty0"


%packages 
@ Base
@ Core
@ System administration tools
-NetworkManager
-NetworkManager-gnome
-NetworkManager-vpnc
rhn-check
rhn-setup
rhncfg
rhncfg-client
rhncfg-actions
osad
yum-rhn-plugin
python-ethtool
python-dmidecode
compat-glibc.x86_64
compat-libstdc++-33.i686
compat-libstdc++-33.x86_64
glibc.i686
ksh
libgcc.i686
libstdc++.i686
lsscsi
nfs-utils
xinetd
cloud-init
cloud-utils
cloud-utils-growpart
dracut-modules-growroot
%end

%post --nochroot

# ------------------------------------
# Sync_Date_and_Time
# ------------------------------------
echo "Syncing time with ntp-1"
/usr/sbin/ntpdate ntp-1
/usr/sbin/hwclock --systohc 2>&1


mkdir /mnt/sysimage/tmp/ks-tree-copy
if [ -d /oldtmp/ks-tree-shadow ]; then
cp -fa /oldtmp/ks-tree-shadow/* /mnt/sysimage/tmp/ks-tree-copy
elif [ -d /tmp/ks-tree-shadow ]; then
cp -fa /tmp/ks-tree-shadow/* /mnt/sysimage/tmp/ks-tree-copy
fi
cp /etc/resolv.conf /mnt/sysimage/etc/resolv.conf
cp -f /tmp/ks-pre.log* /mnt/sysimage/root/ || :

cp `awk '{ if ($1 ~ /%include/) {print $2}}' /tmp/ks.cfg` /tmp/ks.cfg /mnt/sysimage/root
%end

%post 

# fetch post scripts needed for post boot initialization in walmart env
wget http://KICK_HOST/kickstarts/Red_Hat_6_Walmart_post.sh -O /usr/local/bin/Red_Hat_6_Walmart_post.sh
chmod +x /usr/local/bin/Red_Hat_6_Walmart_post.sh
wget http://KICK_HOST/kickstarts/Red_Hat_6_Walmart_post.py -O /usr/local/bin/Red_Hat_6_Walmart_post.py

# update all
yum -y update

cat > /etc/ntp.conf <<'EOF'
# For more information about this file, see the man pages
# ntp.conf(5), ntp_acc(5), ntp_auth(5), ntp_clock(5), ntp_misc(5), ntp_mon(5).

driftfile /var/lib/ntp/drift

# Permit time synchronization with our time source, but do not
# permit the source to query or modify the service on this system.
restrict default kod nomodify notrap nopeer noquery
restrict -6 default kod nomodify notrap nopeer noquery

# Permit all access over the loopback interface.  This could
# be tightened as well, but to do so would effect some of
# the administrative functions.
restrict 127.0.0.1 
restrict -6 ::1

# Hosts on local network are less restricted.
#restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap

# Use public servers from the pool.ntp.org project.
# Please consider joining the pool (http://www.pool.ntp.org/join.html).
server time.dfw1.rackspace.com prefer
server time.iad1.rackspace.com prefer
server time.lon.rackspace.com prefer
server time.hkg1.rackspace.com prefer
server time.ord1.rackspace.com prefer
server time.syd2.rackspace.com prefer

#broadcast 192.168.1.255 autokey    # broadcast server
#broadcastclient            # broadcast client
#broadcast 224.0.1.1 autokey        # multicast server
#multicastclient 224.0.1.1      # multicast client
#manycastserver 239.255.254.254     # manycast server
#manycastclient 239.255.254.254 autokey # manycast client

# Enable public key cryptography.
#crypto

includefile /etc/ntp/crypto/pw

# Key file containing the keys and key identifiers used when operating
# with symmetric key cryptography. 
keys /etc/ntp/keys

# Specify the key identifiers which are trusted.
#trustedkey 4 8 42

# Specify the key identifier to use with the ntpdc utility.
#requestkey 8

# Specify the key identifier to use with the ntpq utility.
#controlkey 8

# Enable writing of statistics records.
#statistics clockstats cryptostats loopstats peerstats
EOF

# make sure repos are empty for rhel
for k in $(find /etc/yum.repos.d -type f); do rm -f $k; done

# our cloud-init config
cat > /etc/cloud/cloud.cfg.d/10_rackspace.cfg <<'EOF'
datasource_list: [ ConfigDrive, None ]
disable_root: False
ssh_pwauth: True
ssh_deletekeys: False
resize_rootfs: noblock
manage_resolv_conf: False
manage_etc_hosts: localhost
growpart:
  mode: auto
  devices: ['/']
system_info:
  distro: rhel
cloud_config_modules:
 - disk_setup
 - mounts
 - ssh-import-id
 - locale
 - set-passwords
 - package-update-upgrade-install
 - landscape
 - timezone
 - puppet
 - chef
 - salt-minion
 - mcollective
 - disable-ec2-metadata
 - runcmd
 - byobu
runcmd:
  - bash /usr/local/bin/Red_Hat_6_Walmart_post.sh
  - python /usr/local/bin/Red_Hat_6_Walmart_post.py
EOF

# initscripts don't like this file to be missing.
cat > /etc/sysconfig/network << EOF
NETWORKING=yes
NOZEROCONF=yes
EOF

# For cloud images, 'eth0' _is_ the predictable device name, since
# we don't want to be tied to specific virtual (!) hardware
echo -n > /etc/udev/rules.d/70-persistent-net.rules
echo -n > /lib/udev/rules.d/75-persistent-net-generator.rules
ln -s /dev/null /etc/udev/rules.d/80-net-name-slot.rules

# simple eth0 config, again not hard-coded to the build hardware
cat > /etc/sysconfig/network-scripts/ifcfg-eth0 << EOF
DEVICE="eth0"
BOOTPROTO="dhcp"
ONBOOT="yes"
TYPE="Ethernet"
EOF

mkdir /u
ln -s /home /u/users
%end
