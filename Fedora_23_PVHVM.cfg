## ksline: net.ifnames=0 ks=http://<kick_host>/ks.cfg

# Install, not upgrade
install
cmdline

# Install from a friendly mirror and add updates
url --url=http://mirror.rackspace.com/fedora/releases/23/Server/x86_64/os/
repo --name=fedora --baseurl=http://mirror.rackspace.com/fedora/releases/23/Everything/x86_64/os/


# Language and keyboard setup
lang en_US.UTF-8
keyboard --vckeymap=us

# Configure DHCP networking w/optional IPv6, firewall on
network --onboot yes --device eth0 --bootproto dhcp --ipv6 auto --hostname localhost
firewall --enabled --service=ssh

# Set timezone
timezone --utc Etc/UTC

# Authentication
rootpw --plaintext novaagentneedsunlockedrootaccountsowedeletepasswordinpost
authconfig --enableshadow --passalgo=sha512

# SELinux
selinux --permissive

# Services running at boot
services --enabled network,sshd,cloud-init-local,cloud-init,cloud-config,cloud-final

# Disable anything graphical
skipx

# Setup the disk
clearpart --all
zerombr
part / --fstype=ext4 --grow --size=1024 --asprimary --label=/
bootloader --timeout=1 --append="root=/dev/xvda1 net.ifnames=0"

# Shutdown when the kickstart is done
shutdown --eject

## no need to run firstboot
firstboot --disable

# Minimal package set (Core and Base groups are included by default)
%packages
@^minimal-environment
chrony
man-pages
cloud-init
cloud-utils


# We need this image to be portable; also, rescue mode isn't useful here.
dracut-config-generic
-dracut-config-rescue

# extras
rsync
tar
wget
curl
which
nmap-ncat
nc6

# Some things from @core we can do without in a minimal install
-biosdevname
-plymouth
-iprutils

%end

%post --erroronfail

# If you want to remove rsyslog and just use journald, remove this!
rmdir /var/log/journal/ 

# let's get rid of zeroconf
cat > /etc/sysconfig/network << EOF
NETWORKING=yes
NOZEROCONF=yes
EOF

# simple eth0 config, not hard-coded to the build hardware
cat > /etc/sysconfig/network-scripts/ifcfg-eth0 << EOF
DEVICE="eth0"
BOOTPROTO="static"
ONBOOT="yes"
TYPE="Ethernet"
EOF

# Because memory is scarce resource in most cloud/virt environments,
# and because this impedes forensics, we are differing from the Fedora
# default of having /tmp on tmpfs.
echo "Disabling tmpfs for /tmp."
systemctl mask tmp.mount

# networking is handled by nova-agent
systemctl mask NetworkManager
systemctl mask NetworkManager-wait-online

# our cloud-init config
cat > /etc/cloud/cloud.cfg.d/10_rackspace.cfg <<'EOF'
datasource_list: [ ConfigDrive, None ]
manage-resolv-conf: false
disable_root: False
ssh_pwauth: True
ssh_deletekeys: False
resize_rootfs: noblock
EOF

#
# install xen tools and nova agent
#
mkdir /tmp/tools-install
cd /tmp/tools-install

# install xen tools
wget http://ce3598b91333d7474379-b85ce4d8c2253d3876bef92f62a263f8.r84.cf5.rackcdn.com/xe-guest-utilities-6.2.0-1120.x86_64.rpm
wget http://ce3598b91333d7474379-b85ce4d8c2253d3876bef92f62a263f8.r84.cf5.rackcdn.com/xe-guest-utilities-xenstore-6.2.0-1120.x86_64.rpm
rpm -Uhv xe-guest-utilities*.rpm

# install nova-agent
##wget http://KICK_HOST/nova-agent-0.2.1-1.fc23.noarch.rpm -O nova-agent.rpm
##rpm -Uvh nova-agent.rpm
wget http://KICK_HOST/nova-agent/nova-agent-1.39.1-1.fc23.tar.gz -O nova-agent.tgz
tar xfzC nova-agent.tgz /

# a systemd service file for nova-agent
cat > /usr/lib/systemd/system/nova-agent.service <<'EOF'
[Unit]
Description=nova-agent service
After=xe-linux-distribution.service
[Service]
EnvironmentFile=/etc/nova-agent.env
ExecStart=/usr/sbin/nova-agent -n -l info /usr/share/nova-agent/nova-agent.py
[Install]
WantedBy=multi-user.target
EOF

cat > /etc/nova-agent.env <<'EOF'
LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:/usr/share/nova-agent/1.39.1/lib"
PYTHONPATH="${PYTHONPATH}:/usr/share/nova-agent/1.39.1/lib/python2.7/site-packages:/usr/share/nova-agent/1.39.1/lib/python2.7/"
EOF

systemctl daemon-reload
systemctl enable nova-agent


# modify sysctl parameters for cloud
echo 'net.ipv4.conf.eth0.arp_notify = 1' >> /etc/sysctl.conf
echo 'vm.swappiness = 0' >> /etc/sysctl.conf

cat >> /etc/sysctl.conf <<'EOF'
net.ipv4.tcp_rmem = 4096 87380 33554432
net.ipv4.tcp_wmem = 4096 65536 33554432
net.core.rmem_max = 33554432
net.core.wmem_max = 33554432
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
EOF

# make fstab sane
cat > /etc/fstab <<'EOF'
/dev/xvda1 / ext4 defaults,errors=remount-ro,noatime,barrier=0 0 1
EOF

# set rackspace mirrors
sed -i '/^#baseurl=/c\baseurl=http://mirror.rackspace.com/fedora/releases/$releasever/Server/$basearch/os/' /etc/yum.repos.d/*.repo
sed -i '/metalink/s/^/#/' /etc/yum.repos.d/*.repo

# update all
dnf -y update

# cloud-init fixes for nova-agent race condition
###cat > /usr/lib/systemd/system/cloud-init-local.service <<'EOF'
###[Unit]
###Description=Initial cloud-init job (pre-networking)
###Wants=local-fs.target
###After=local-fs.target

###[Service]
###Type=oneshot
###ExecStartPre=/usr/bin/sleep 20
###ExecStart=/usr/bin/cloud-init init --local
###RemainAfterExit=yes
###TimeoutSec=0

# Output needs to appear in instance console output
###StandardOutput=journal+console

###[Install]
###WantedBy=multi-user.target
###EOF


# log packages
wget http://KICK_HOST/kickstarts/package_postback.sh
bash package_postback.sh Fedora_23_PVHVM

# clean up
passwd -d root
yum clean all
truncate -c -s 0 /etc/machine-id
rm -rf /tmp/tools-install
rm -f /installer.sh
rm -f /etc/ssh/ssh_host_*
rm -f /etc/resolv.conf
touch /etc/resolv.conf
rm -f /root/.bash_history
rm -f /root/.nano_history
rm -f /root/.lesshst
rm -f /root/.ssh/known_hosts
###rm -rf /var/log/anaconda/
###find /var/log -type f ! -iname README -exec truncate -s 0 {} \;
find /tmp -type f -delete
find /root -type f ! -iname ".*" -delete

%end
